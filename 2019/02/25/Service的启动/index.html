<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="framework," />










<meta name="description" content="以Android 8.0版本为基础，以启动运行在新进程的Service为场景，分析启动的流程，了解了Binder和AMS后会好理解些。">
<meta name="keywords" content="framework">
<meta property="og:type" content="article">
<meta property="og:title" content="Service的启动">
<meta property="og:url" content="http://yoursite.com/2019/02/25/Service的启动/index.html">
<meta property="og:site_name" content="Chenjialong Blog">
<meta property="og:description" content="以Android 8.0版本为基础，以启动运行在新进程的Service为场景，分析启动的流程，了解了Binder和AMS后会好理解些。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-02-27T07:44:22.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Service的启动">
<meta name="twitter:description" content="以Android 8.0版本为基础，以启动运行在新进程的Service为场景，分析启动的流程，了解了Binder和AMS后会好理解些。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/02/25/Service的启动/"/>





  <title>Service的启动 | Chenjialong Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0fdca51910b3bd30aa8b27491063552d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Chenjialong Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Repository for original articles and quality reprint article!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/25/Service的启动/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chenjialong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjialong Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Service的启动</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-25T14:15:28+08:00">
                2019年02月25日
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>以Android 8.0版本为基础，以启动运行在新进程的Service为场景，分析启动的流程，了解了Binder和AMS后会好理解些。<br><a id="more"></a><br><!-- 启动流程：
    客户端进程向AMS发起启动Service请求；
    AMS处理Intent信息及一些情况；
    发送Service创建超时的延时消息；
    向客户端发起IPC进行Service的创建；
    回调Service的onStartCommand()方法；
    客户端进程回调onStartCommand；
销毁流程：
    客户端进程向AMS发起销毁Service请求；
    Service销毁成功。 --></p>
<h5 id="客户端进程向AMS发起启动Service请求"><a href="#客户端进程向AMS发起启动Service请求" class="headerlink" title="客户端进程向AMS发起启动Service请求"></a>客户端进程向AMS发起启动Service请求</h5><p>在Activity中调用<code>startService()</code>启动Service，但实际上Activity没有此方法，是其父类ContextWrapper实现的。</p>
<h6 id="ContextWrapper-startService"><a href="#ContextWrapper-startService" class="headerlink" title="ContextWrapper.startService"></a>ContextWrapper.startService</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(Intent service)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> mBase.startService(service);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><code>mBase</code>：ContextImpl；<br>为什么是ContextImpl？<br>在<code>AT.performLaunchActivity()</code>中，把创建好的ContextImpl传到<code>Activity.attach()</code>中，然后又传到<code>attachBaseContext()</code>中，最后赋给了ContextWrapper的<code>mBase</code>变量。</p>
<h6 id="ContextImpl-startService"><a href="#ContextImpl-startService" class="headerlink" title="ContextImpl.startService"></a>ContextImpl.startService</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(Intent service)</span> </span>&#123;</span><br><span class="line">       warnIfCallingFromSystemProcess();</span><br><span class="line">       <span class="keyword">return</span> startServiceCommon(service, <span class="keyword">false</span>, mUser);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h6 id="ContextImpl-startServiceCommon"><a href="#ContextImpl-startServiceCommon" class="headerlink" title="ContextImpl.startServiceCommon"></a>ContextImpl.startServiceCommon</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ComponentName <span class="title">startServiceCommon</span><span class="params">(Intent service, <span class="keyword">boolean</span> requireForeground, UserHandle user)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">       	<span class="comment">//验证Intent参数</span></span><br><span class="line">           validateServiceIntent(service);</span><br><span class="line">           service.prepareToLeaveProcess(<span class="keyword">this</span>);</span><br><span class="line">           <span class="comment">//ActivityManager.getService()就是AMS在客户端进程的本地代理</span></span><br><span class="line">           ComponentName cn = ActivityManager.getService().startService(mMainThread.getApplicationThread(), service, </span><br><span class="line">           			service.resolveTypeIfNeeded(getContentResolver()), requireForeground, getOpPackageName(), user.getIdentifier());</span><br><span class="line">           <span class="keyword">if</span> (cn != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">if</span> (cn.getPackageName().equals(<span class="string">"!"</span>)) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Not allowed to start service "</span> + service + <span class="string">" without permission "</span> + cn.getClassName());</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cn.getPackageName().equals(<span class="string">"!!"</span>)) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Unable to start service "</span> + service + <span class="string">": "</span> + cn.getClassName());</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cn.getPackageName().equals(<span class="string">"?"</span>)) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Not allowed to start service "</span> + service + <span class="string">": "</span> + cn.getClassName());</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> cn;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>经过Binder驱动，最终<code>AMS.startService()</code>被调用。</p>
<h5 id="AMS处理Intent信息及一些情况"><a href="#AMS处理Intent信息及一些情况" class="headerlink" title="AMS处理Intent信息及一些情况"></a>AMS处理Intent信息及一些情况</h5><h6 id="AMS-startService"><a href="#AMS-startService" class="headerlink" title="AMS.startService"></a>AMS.startService</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(IApplicationThread caller, Intent service, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">boolean</span> requireForeground, String callingPackage, <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line">       enforceNotIsolatedCaller(<span class="string">"startService"</span>);</span><br><span class="line">       <span class="keyword">if</span> (service != <span class="keyword">null</span> &amp;&amp; service.hasFileDescriptors() == <span class="keyword">true</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (callingPackage == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"callingPackage cannot be null"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">           ComponentName res;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               res = mServices.startServiceLocked(caller, service, resolvedType, callingPid,</span><br><span class="line">               		callingUid, requireForeground, callingPackage, userId);</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               Binder.restoreCallingIdentity(origId);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> res;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><code>mServices</code>：ActiveServices。<br><code>caller</code>：客户端进程的IApplicationThread在AMS所在进程的本地代理，可间接调用客户端进程的ApplicationThread。</p>
<h6 id="ActiveServices-startServiceLocked"><a href="#ActiveServices-startServiceLocked" class="headerlink" title="ActiveServices.startServiceLocked"></a>ActiveServices.startServiceLocked</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ComponentName <span class="title">startServiceLocked</span><span class="params">(IApplicationThread caller, Intent service, String resolvedType, <span class="keyword">int</span> callingPid,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">int</span> callingUid, <span class="keyword">boolean</span> fgRequired, String callingPackage, <span class="keyword">final</span> <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line">	<span class="comment">//发起调用的进程是否为前台应用</span></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> callerFg;</span><br><span class="line">       <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">final</span> ProcessRecord callerApp = mAm.getRecordForAppLocked(caller);</span><br><span class="line">           <span class="keyword">if</span> (callerApp == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Unable to find app for caller "</span> + caller</span><br><span class="line">                       + <span class="string">" (pid="</span> + callingPid + <span class="string">") when starting service "</span> + service);</span><br><span class="line">           &#125;</span><br><span class="line">           callerFg = callerApp.setSchedGroup != ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           callerFg = <span class="keyword">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//从ServiceMap中根据Intent查找缓存的ServiceRecord，如没有缓存则通过PMS检索Intent信息，包装成ServiceLookupResult然后返回</span></span><br><span class="line">       ServiceLookupResult res = retrieveServiceLocked(service, resolvedType, callingPackage,</span><br><span class="line">                   				callingPid, callingUid, userId, <span class="keyword">true</span>, callerFg, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">       <span class="keyword">if</span> (res == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//启动失败，权限问题</span></span><br><span class="line">       <span class="keyword">if</span> (res.record == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(<span class="string">"!"</span>, res.permission != <span class="keyword">null</span> ? res.permission : <span class="string">"private to package"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       ServiceRecord r = res.record;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!mAm.mUserController.exists(r.userId)) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//如果是间接启动Service(例如从PendingContent启动)，则判断是否在后台状态下启动Service</span></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> bgLaunch = !mAm.isUidActiveLocked(r.appInfo.uid);</span><br><span class="line">       <span class="comment">//如果有设置后台限制，将限制Service启动</span></span><br><span class="line">       <span class="keyword">boolean</span> forcedStandby = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">if</span> (bgLaunch &amp;&amp; appRestrictedAnyInBackground(r.appInfo.uid, r.packageName)) &#123;</span><br><span class="line">           forcedStandby = <span class="keyword">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//fgRequired为false，forceSilentAbort也是false</span></span><br><span class="line">       <span class="keyword">boolean</span> forceSilentAbort = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">if</span> (fgRequired) &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> mode = mAm.mAppOpsService.checkOperation(AppOpsManager.OP_START_FOREGROUND, r.appInfo.uid, r.packageName);</span><br><span class="line">           <span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">               <span class="keyword">case</span> AppOpsManager.MODE_ALLOWED:</span><br><span class="line">               <span class="keyword">case</span> AppOpsManager.MODE_DEFAULT:</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">case</span> AppOpsManager.MODE_IGNORED:</span><br><span class="line">                   fgRequired = <span class="keyword">false</span>;</span><br><span class="line">                   forceSilentAbort = <span class="keyword">true</span>;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">default</span>:</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(<span class="string">"!!"</span>, <span class="string">"foreground not allowed as per app op"</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//检查是否允许启动Service</span></span><br><span class="line">       <span class="keyword">if</span> (forcedStandby || (!r.startRequested &amp;&amp; !fgRequired)) &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> allowed = mAm.getAppStartModeLocked(r.appInfo.uid, r.packageName,</span><br><span class="line">                   r.appInfo.targetSdkVersion, callingPid, <span class="keyword">false</span>, <span class="keyword">false</span>, forcedStandby);</span><br><span class="line">           <span class="keyword">if</span> (allowed != ActivityManager.APP_START_MODE_NORMAL) &#123;</span><br><span class="line">               <span class="keyword">if</span> (allowed == ActivityManager.APP_START_MODE_DELAYED || forceSilentAbort) &#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (forcedStandby) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (fgRequired) &#123;</span><br><span class="line">                       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               UidRecord uidRec = mAm.mActiveUids.get(r.appInfo.uid);</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(<span class="string">"?"</span>, <span class="string">"app is in background uid "</span> + uidRec);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//androd8.0版本以下，设置fgRequired保证其为false，</span></span><br><span class="line">       <span class="keyword">if</span> (r.appInfo.targetSdkVersion &lt; Build.VERSION_CODES.O &amp;&amp; fgRequired) &#123;</span><br><span class="line">           fgRequired = <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       ...</span><br><span class="line">       r.lastActivity = SystemClock.uptimeMillis();</span><br><span class="line">       r.startRequested = <span class="keyword">true</span>;</span><br><span class="line">       r.delayedStop = <span class="keyword">false</span>;</span><br><span class="line">       r.fgRequired = fgRequired;</span><br><span class="line">       r.pendingStarts.add(<span class="keyword">new</span> ServiceRecord.StartItem(r, <span class="keyword">false</span>, r.makeNextStartId(),service, neededGrants, callingUid));</span><br><span class="line">       <span class="keyword">if</span> (fgRequired) &#123;</span><br><span class="line">           mAm.mAppOpsService.startOperation(AppOpsManager.getToken(mAm.mAppOpsService),</span><br><span class="line">                   AppOpsManager.OP_START_FOREGROUND, r.appInfo.uid, r.packageName, <span class="keyword">true</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">final</span> ServiceMap smap = getServiceMapLocked(r.userId);</span><br><span class="line">       <span class="keyword">boolean</span> addToStarting = <span class="keyword">false</span>;</span><br><span class="line">       <span class="comment">//处理延迟启动Service的情况，调用进程在前台，非前台Service</span></span><br><span class="line">       <span class="keyword">if</span> (!callerFg &amp;&amp; !fgRequired &amp;&amp; r.app == <span class="keyword">null</span> &amp;&amp; mAm.mUserController.hasStartedUserState(r.userId)) &#123;</span><br><span class="line">           ProcessRecord proc = mAm.getProcessRecordLocked(r.processName, r.appInfo.uid, <span class="keyword">false</span>);</span><br><span class="line">           <span class="comment">//proc.curProcState当前进程状态，值越大优先级越低</span></span><br><span class="line">           <span class="keyword">if</span> (proc == <span class="keyword">null</span> || proc.curProcState &gt; ActivityManager.PROCESS_STATE_RECEIVER) &#123;</span><br><span class="line">               <span class="comment">//当前状态是延迟启动，直接返回</span></span><br><span class="line">               <span class="keyword">if</span> (r.delayed) &#123;</span><br><span class="line">                   <span class="keyword">return</span> r.name;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (smap.mStartingBackground.size() &gt;= mMaxStartingBackground) &#123;</span><br><span class="line">                   smap.mDelayedStartList.add(r);</span><br><span class="line">                   r.delayed = <span class="keyword">true</span>;</span><br><span class="line">                   <span class="keyword">return</span> r.name;</span><br><span class="line">               &#125;</span><br><span class="line">               addToStarting = <span class="keyword">true</span>;</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proc.curProcState &gt;= ActivityManager.PROCESS_STATE_SERVICE) &#123;</span><br><span class="line">               addToStarting = <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       ComponentName cmp = startServiceInnerLocked(smap, service, r, callerFg, addToStarting);</span><br><span class="line">       <span class="keyword">return</span> cmp;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>处理Intent信息是否合法；<br>针对Service前台后台的情况判断是否可以启动；<br>设置ServiceRecord参数；<br>处理延迟启动Service。</p>
<h6 id="ActiveServices-startServiceInnerLocked"><a href="#ActiveServices-startServiceInnerLocked" class="headerlink" title="ActiveServices.startServiceInnerLocked"></a>ActiveServices.startServiceInnerLocked</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ComponentName <span class="title">startServiceInnerLocked</span><span class="params">(ServiceMap smap, Intent service, ServiceRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">boolean</span> callerFg, <span class="keyword">boolean</span> addToStarting)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line">       ServiceState stracker = r.getTracker();</span><br><span class="line">       <span class="keyword">if</span> (stracker != <span class="keyword">null</span>) &#123;</span><br><span class="line">           stracker.setStarted(<span class="keyword">true</span>, mAm.mProcessStats.getMemFactorLocked(), r.lastActivity);</span><br><span class="line">       &#125;</span><br><span class="line">       r.callStart = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</span><br><span class="line">           r.stats.startRunningLocked();</span><br><span class="line">       &#125;</span><br><span class="line">       String error = bringUpServiceLocked(r, service.getFlags(), callerFg, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">       <span class="keyword">if</span> (error != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(<span class="string">"!!"</span>, error);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//处理延迟启动</span></span><br><span class="line">       <span class="keyword">if</span> (r.startRequested &amp;&amp; addToStarting) &#123;</span><br><span class="line">           <span class="keyword">boolean</span> first = smap.mStartingBackground.size() == <span class="number">0</span>;</span><br><span class="line">           smap.mStartingBackground.add(r);</span><br><span class="line">           r.startingBgTimeout = SystemClock.uptimeMillis() + mAm.mConstants.BG_START_TIMEOUT;</span><br><span class="line">           <span class="keyword">if</span> (first) &#123;</span><br><span class="line">               smap.rescheduleDelayedStartsLocked();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (callerFg || r.fgRequired) &#123;</span><br><span class="line">           smap.ensureNotStartingBackgroundLocked(r);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> r.name;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h6 id="ActiveServices-bringUpServiceLocked"><a href="#ActiveServices-bringUpServiceLocked" class="headerlink" title="ActiveServices.bringUpServiceLocked"></a>ActiveServices.bringUpServiceLocked</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">bringUpServiceLocked</span><span class="params">(ServiceRecord r, <span class="keyword">int</span> intentFlags, <span class="keyword">boolean</span> execInFg, <span class="keyword">boolean</span> whileRestarting,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">boolean</span> permissionsReviewRequired)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line">	<span class="comment">//Service所在进程存在，直接发起IPC调用Service的onStartCommand方法</span></span><br><span class="line">       <span class="keyword">if</span> (r.app != <span class="keyword">null</span> &amp;&amp; r.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">           sendServiceArgsLocked(r, execInFg, <span class="keyword">false</span>);</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//Service正在重启，直接返回</span></span><br><span class="line">       <span class="keyword">if</span> (!whileRestarting &amp;&amp; mRestartingServices.contains(r)) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//从重启列表中移除</span></span><br><span class="line">       <span class="keyword">if</span> (mRestartingServices.remove(r)) &#123;</span><br><span class="line">           clearRestartingIfNeededLocked(r);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//Service不再是延迟状态，重设重启等状态</span></span><br><span class="line">       <span class="keyword">if</span> (r.delayed) &#123;</span><br><span class="line">           getServiceMapLocked(r.userId).mDelayedStartList.remove(r);</span><br><span class="line">           r.delayed = <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//Service所在用户未启动启动失败</span></span><br><span class="line">       <span class="keyword">if</span> (!mAm.mUserController.hasStartedUserState(r.userId)) &#123;</span><br><span class="line">           String msg = <span class="string">"Unable to launch app "</span> + r.appInfo.packageName + <span class="string">"/"</span> + r.appInfo.uid +</span><br><span class="line">           			<span class="string">" for service "</span> + r.intent.getIntent() + <span class="string">": user "</span> + r.userId + <span class="string">" is stopped"</span>;</span><br><span class="line">           bringDownServiceLocked(r);</span><br><span class="line">           <span class="keyword">return</span> msg;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           AppGlobals.getPackageManager().setPackageStoppedState(r.packageName, <span class="keyword">false</span>, r.userId);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> isolated = (r.serviceInfo.flags&amp;ServiceInfo.FLAG_ISOLATED_PROCESS) != <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">final</span> String procName = r.processName;</span><br><span class="line">       String hostingType = <span class="string">"service"</span>;</span><br><span class="line">       ProcessRecord app;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!isolated) &#123;</span><br><span class="line">       	<span class="comment">//根据进程名和uid查找对应的ProcessRecord</span></span><br><span class="line">           app = mAm.getProcessRecordLocked(procName, r.appInfo.uid, <span class="keyword">false</span>);</span><br><span class="line">           <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   app.addPackage(r.appInfo.packageName, r.appInfo.longVersionCode, mAm.mProcessStats);</span><br><span class="line">                   <span class="comment">//如果ProcessRecord信息存在则启动Service</span></span><br><span class="line">                   realStartServiceLocked(r, app, execInFg);</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">               &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> e;</span><br><span class="line">               &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           app = r.isolatedProc;</span><br><span class="line">           <span class="keyword">if</span> (WebViewZygote.isMultiprocessEnabled()</span><br><span class="line">                   &amp;&amp; r.serviceInfo.packageName.equals(WebViewZygote.getPackageName())) &#123;</span><br><span class="line">               hostingType = <span class="string">"webview_service"</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//查不到Service所在进程信息，调用AMS.startProcessLocked()启动新进程</span></span><br><span class="line">       <span class="keyword">if</span> (app == <span class="keyword">null</span> &amp;&amp; !permissionsReviewRequired) &#123;</span><br><span class="line">           <span class="keyword">if</span> ((app=mAm.startProcessLocked(procName, r.appInfo, <span class="keyword">true</span>, intentFlags,</span><br><span class="line">                   hostingType, r.name, <span class="keyword">false</span>, isolated, <span class="keyword">false</span>)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">               String msg = <span class="string">"Unable to launch app "</span> + r.appInfo.packageName + <span class="string">"/"</span></span><br><span class="line">                       + r.appInfo.uid + <span class="string">" for service "</span> + r.intent.getIntent() + <span class="string">": process is bad"</span>;</span><br><span class="line">               bringDownServiceLocked(r);</span><br><span class="line">               <span class="keyword">return</span> msg;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (isolated) &#123;</span><br><span class="line">               r.isolatedProc = app;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (r.fgRequired) &#123;</span><br><span class="line">           mAm.tempWhitelistUidLocked(r.appInfo.uid,SERVICE_START_FOREGROUND_TIMEOUT, <span class="string">"fg-service-launch"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//把ServiceRecord添加到待启动列表中，进程创建好之后会读取mPendingServices启动Service</span></span><br><span class="line">       <span class="keyword">if</span> (!mPendingServices.contains(r)) &#123;</span><br><span class="line">           mPendingServices.add(r);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//延迟启动被取消且Service已启动，则停止Service</span></span><br><span class="line">       <span class="keyword">if</span> (r.delayedStop) &#123;</span><br><span class="line">           r.delayedStop = <span class="keyword">false</span>;</span><br><span class="line">           <span class="keyword">if</span> (r.startRequested) &#123;</span><br><span class="line">               stopServiceLocked(r);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>如果ServiceRecord已经绑定了ProcessRecord，并且ProcessRecord绑定了客户端进程的IApplicationThread的本地代理，则直接回调Service的onStartCommand方法。</p>
<p>准备启动Service了，这里分为2种情况：</p>
<ul>
<li>首先判断进程如果存在，则直接调用<code>ActiveServices.realStartServiceLocked()</code>进行Service真正的启动；</li>
<li>如果进程不存在，会先调用<code>AMS.startProcessLocked()</code>创建进程，然后把待启动的ServiceRecord添加到<code>mPendingServices</code>中。AMS通知Zygote进程fork出新的子进程，经过一系列的调用后回到<code>AMS.attachApplicationLocked()</code>方法中，然后调用<code>ActiveServices.attachApplicationLocked()</code>处理<code>mPendingServices</code>，判断uid和进程名相同时后调用<code>ActiveServices.realStartServiceLocked()</code>。后面的流程便和进程存在的情况相一致了。其中从<code>AMS.startProcessLocked()</code>到<code>AMS.attachApplicationLocked()</code>和Activity启动流程第3部分是一样的，不再分析<br><a href="http://www.momoandy.com/2019/01/02/%E5%90%AF%E5%8A%A8Activity%E8%BF%87%E7%A8%8B/" target="_blank" rel="noopener"><strong>(点击查看)</strong></a></li>
</ul>
<p>然后往下看<code>ActiveServices.realStartServiceLocked()</code>：</p>
<h6 id="ActiveServices-realStartServiceLocked"><a href="#ActiveServices-realStartServiceLocked" class="headerlink" title="ActiveServices.realStartServiceLocked"></a>ActiveServices.realStartServiceLocked</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">realStartServiceLocked</span><span class="params">(ServiceRecord r, ProcessRecord app, <span class="keyword">boolean</span> execInFg)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (app.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//ServiceRecord绑定进程信息</span></span><br><span class="line">       r.app = app;</span><br><span class="line">       r.restartTime = r.lastActivity = SystemClock.uptimeMillis();</span><br><span class="line">       <span class="comment">//ProcessRecord保存一份ServiceRecord的引用</span></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> newService = app.services.add(r);</span><br><span class="line">       <span class="comment">//发送一个创建Service超时的ANR消息</span></span><br><span class="line">       bumpServiceExecutingLocked(r, execInFg, <span class="string">"create"</span>);</span><br><span class="line">       mAm.updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">       updateServiceForegroundLocked(r.app, <span class="comment">/* oomAdj= */</span> <span class="keyword">false</span>);</span><br><span class="line">       mAm.updateOomAdjLocked();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</span><br><span class="line">               r.stats.startLaunchedLocked();</span><br><span class="line">           &#125;</span><br><span class="line">           mAm.notifyPackageUse(r.serviceInfo.packageName,PackageManager.NOTIFY_PACKAGE_USE_SERVICE);</span><br><span class="line">           app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</span><br><span class="line">           <span class="comment">//一切准备完毕，向客户端发起IPC进行Service的创建</span></span><br><span class="line">           app.thread.scheduleCreateService(r, r.serviceInfo,</span><br><span class="line">                   mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),</span><br><span class="line">                   app.repProcState);</span><br><span class="line">           r.postNotification();</span><br><span class="line">           created = <span class="keyword">true</span>;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (DeadObjectException e) &#123;</span><br><span class="line">           mAm.appDiedLocked(app);</span><br><span class="line">           <span class="keyword">throw</span> e;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (!created) &#123;</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line">               serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line">               <span class="comment">//请求AMS缓存的ProcessRecord</span></span><br><span class="line">               <span class="keyword">if</span> (newService) &#123;</span><br><span class="line">                   app.services.remove(r);</span><br><span class="line">                   r.app = <span class="keyword">null</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">//如发生异常但Serive又不是主动销毁的再次重启Service</span></span><br><span class="line">               <span class="keyword">if</span> (!inDestroying) &#123;</span><br><span class="line">                   scheduleServiceRestartLocked(r, <span class="keyword">false</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (r.whitelistManager) &#123;</span><br><span class="line">           app.whitelistManager = <span class="keyword">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       requestServiceBindingsLocked(r, execInFg);</span><br><span class="line">       updateServiceClientActivitiesLocked(app, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//伪造一个StartItem以便于后面调用Service的onStartCommand方法</span></span><br><span class="line">       <span class="keyword">if</span> (r.startRequested &amp;&amp; r.callStart &amp;&amp; r.pendingStarts.size() == <span class="number">0</span>) &#123;</span><br><span class="line">           r.pendingStarts.add(<span class="keyword">new</span> ServiceRecord.StartItem(r, <span class="keyword">false</span>, r.makeNextStartId(),</span><br><span class="line">                   <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//发起IPC回调客户端Service的onStartCommand方法</span></span><br><span class="line">       sendServiceArgsLocked(r, execInFg, <span class="keyword">true</span>);</span><br><span class="line">       <span class="comment">//重设重启等状态</span></span><br><span class="line">       <span class="keyword">if</span> (r.delayed) &#123;</span><br><span class="line">           getServiceMapLocked(r.userId).mDelayedStartList.remove(r);</span><br><span class="line">           r.delayed = <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//延迟启动被取消且Service已启动，则停止Service</span></span><br><span class="line">       <span class="keyword">if</span> (r.delayedStop) &#123;</span><br><span class="line">           r.delayedStop = <span class="keyword">false</span>;</span><br><span class="line">           <span class="keyword">if</span> (r.startRequested) &#123;</span><br><span class="line">               stopServiceLocked(r);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ServiceRecord和ProcessRecord相互绑定；</li>
<li>发送一个<code>创建Service</code>超时的ANR消息；</li>
<li>调用<code>app.thread.scheduleCreateService()</code>向客户端发起IPC进行Service的创建；</li>
<li>调用<code>sendServiceArgsLocked()</code>，向客户端发起IPC回调Service的<code>onStartCommand()</code>方法。</li>
</ul>
<h5 id="发送Service创建超时的延时消息"><a href="#发送Service创建超时的延时消息" class="headerlink" title="发送Service创建超时的延时消息"></a>发送Service创建超时的延时消息</h5><p>调用<code>bumpServiceExecutingLocked()</code>发送一个延时消息，如果这个消息没有被移除，就会执行Service创建超时的流程，最终弹出ANR对话框；如果在超时之前执行完Service的<br><code>onCreate()</code>，便会移除这个延时消息。</p>
<h6 id="ActiveServices-bumpServiceExecutingLocked"><a href="#ActiveServices-bumpServiceExecutingLocked" class="headerlink" title="ActiveServices.bumpServiceExecutingLocked"></a>ActiveServices.bumpServiceExecutingLocked</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bumpServiceExecutingLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> fg, String why)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">boolean</span> timeoutNeeded = <span class="keyword">true</span>;</span><br><span class="line">       <span class="keyword">if</span> ((mAm.mBootPhase &lt; SystemService.PHASE_THIRD_PARTY_APPS_CAN_START)</span><br><span class="line">               &amp;&amp; (r.app != <span class="keyword">null</span>) &amp;&amp; (r.app.pid == android.os.Process.myPid())) &#123;</span><br><span class="line">           timeoutNeeded = <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">       <span class="keyword">if</span> (r.executeNesting == <span class="number">0</span>) &#123;</span><br><span class="line">           r.executeFg = fg;</span><br><span class="line">           ServiceState stracker = r.getTracker();</span><br><span class="line">           <span class="keyword">if</span> (stracker != <span class="keyword">null</span>) &#123;</span><br><span class="line">               stracker.setExecuting(<span class="keyword">true</span>, mAm.mProcessStats.getMemFactorLocked(), now);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">               r.app.executingServices.add(r);</span><br><span class="line">               r.app.execServicesFg |= fg;</span><br><span class="line">               <span class="keyword">if</span> (timeoutNeeded &amp;&amp; r.app.executingServices.size() == <span class="number">1</span>) &#123;</span><br><span class="line">                   scheduleServiceTimeoutLocked(r.app);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.app != <span class="keyword">null</span> &amp;&amp; fg &amp;&amp; !r.app.execServicesFg) &#123;</span><br><span class="line">           r.app.execServicesFg = <span class="keyword">true</span>;</span><br><span class="line">           <span class="keyword">if</span> (timeoutNeeded) &#123;</span><br><span class="line">               scheduleServiceTimeoutLocked(r.app);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       r.executeFg |= fg;</span><br><span class="line">       r.executeNesting++;</span><br><span class="line">       r.executingStart = now;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h6 id="ActiveServices-scheduleServiceTimeoutLocked"><a href="#ActiveServices-scheduleServiceTimeoutLocked" class="headerlink" title="ActiveServices.scheduleServiceTimeoutLocked"></a>ActiveServices.scheduleServiceTimeoutLocked</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleServiceTimeoutLocked</span><span class="params">(ProcessRecord proc)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (proc.executingServices.size() == <span class="number">0</span> || proc.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       Message msg = mAm.mHandler.obtainMessage(ActivityManagerService.SERVICE_TIMEOUT_MSG);</span><br><span class="line">       msg.obj = proc;</span><br><span class="line">       mAm.mHandler.sendMessageDelayed(msg,proc.execServicesFg ? SERVICE_TIMEOUT : SERVICE_BACKGROUND_TIMEOUT);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>AMS的MainHandler发送一个延时的Service超时的消息，<br><code>SERVICE_TIMEOUT</code>：前台服务超时时间20秒。<br><code>SERVICE_BACKGROUND_TIMEOUT</code>：是前台服务的10倍，200秒。</p>
<h5 id="向客户端发起IPC进行Service的创建"><a href="#向客户端发起IPC进行Service的创建" class="headerlink" title="向客户端发起IPC进行Service的创建"></a>向客户端发起IPC进行Service的创建</h5><p><code>app.thread</code>是Service所在进程的IApplicationThread在AMS的本地代理，经过Binder驱动，回到客户端进程，<code>ApplicationThread.scheduleCreateService()</code>被调用。</p>
<h6 id="ApplicationThread-scheduleCreateService"><a href="#ApplicationThread-scheduleCreateService" class="headerlink" title="ApplicationThread.scheduleCreateService"></a>ApplicationThread.scheduleCreateService</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleCreateService</span><span class="params">(IBinder token, ServiceInfo info, CompatibilityInfo compatInfo, <span class="keyword">int</span> processState)</span> </span>&#123;</span><br><span class="line">           updateProcessState(processState, <span class="keyword">false</span>);</span><br><span class="line">           CreateServiceData s = <span class="keyword">new</span> CreateServiceData();</span><br><span class="line">           s.token = token;</span><br><span class="line">           s.info = info;</span><br><span class="line">           s.compatInfo = compatInfo;</span><br><span class="line">           sendMessage(H.CREATE_SERVICE, s);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p><code>token</code>：ServiceRecord是Binder类型，token是ServiceRecord在客户端进程的本地代理，用来映射客户端进程的Service和AMS进程的ServiceRecord。<br>构造CreateServiceData并发送给Hander，最终<code>ActivityThread.handleCreateService()</code>被调用。</p>
<h6 id="ActivityThread-handleCreateService"><a href="#ActivityThread-handleCreateService" class="headerlink" title="ActivityThread.handleCreateService"></a>ActivityThread.handleCreateService</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCreateService</span><span class="params">(CreateServiceData data)</span> </span>&#123;</span><br><span class="line">       unscheduleGcIdler();</span><br><span class="line">       LoadedApk packageInfo = getPackageInfoNoCheck(data.info.applicationInfo, data.compatInfo);</span><br><span class="line">       Service service = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           java.lang.ClassLoader cl = packageInfo.getClassLoader();</span><br><span class="line">           <span class="comment">//LoadedApk使用AppComponentFactory.instantiateService()反射构造Service</span></span><br><span class="line">           service = packageInfo.getAppFactory().instantiateService(cl, data.info.name, data.intent);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           ContextImpl context = ContextImpl.createAppContext(<span class="keyword">this</span>, packageInfo);</span><br><span class="line">           context.setOuterContext(service);</span><br><span class="line">           Application app = packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">           <span class="comment">//Service初始化并回调onCreate方法</span></span><br><span class="line">           service.attach(context, <span class="keyword">this</span>, data.info.name, data.token, app, ActivityManager.getService());</span><br><span class="line">           service.onCreate();</span><br><span class="line">           <span class="comment">//把Service缓存到ActivityThread</span></span><br><span class="line">           mServices.put(data.token, service);</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">           	<span class="comment">//通知AMS客户端进程Service的创建已完毕</span></span><br><span class="line">               ActivityManager.getService().serviceDoneExecuting(data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">               <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>LoadedApk使用AppComponentFactory.instantiateService()反射构造Service；<br>调用Service.attach()保存ActivityThread、ServiceRecord本地代理和AMS本地代理等到Service；<br>调用Service.onCreate方法，onCreate()只在第一次创建的时候被回调，后面只调用onStartCommand方法；<br>把ServiceRecord和Service缓存到ActivityThread；<br>通知AMS调用<code>serviceDoneExecuting()</code>方法。</p>
<h6 id="AMS-serviceDoneExecuting"><a href="#AMS-serviceDoneExecuting" class="headerlink" title="AMS.serviceDoneExecuting"></a>AMS.serviceDoneExecuting</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serviceDoneExecuting</span><span class="params">(IBinder token, <span class="keyword">int</span> type, <span class="keyword">int</span> startId, <span class="keyword">int</span> res)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!(token <span class="keyword">instanceof</span> ServiceRecord)) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid service token"</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           mServices.serviceDoneExecutingLocked((ServiceRecord)token, type, startId, res);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h6 id="ActiveServices-serviceDoneExecutingLocked"><a href="#ActiveServices-serviceDoneExecutingLocked" class="headerlink" title="ActiveServices.serviceDoneExecutingLocked"></a>ActiveServices.serviceDoneExecutingLocked</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">serviceDoneExecutingLocked</span><span class="params">(ServiceRecord r, <span class="keyword">int</span> type, <span class="keyword">int</span> startId, <span class="keyword">int</span> res)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line">       <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">       	<span class="comment">//处理onStartCommand()重启Service策略</span></span><br><span class="line">           ...</span><br><span class="line">           serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>调用<code>serviceDoneExecutingLocked()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">serviceDoneExecutingLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> inDestroying, <span class="keyword">boolean</span> finishing)</span> </span>&#123;</span><br><span class="line">       r.executeNesting--;</span><br><span class="line">       <span class="keyword">if</span> (r.executeNesting &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">               r.app.execServicesFg = <span class="keyword">false</span>;</span><br><span class="line">               r.app.executingServices.remove(r);</span><br><span class="line">               <span class="keyword">if</span> (r.app.executingServices.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                   mAm.mHandler.removeMessages(ActivityManagerService.SERVICE_TIMEOUT_MSG, r.app);</span><br><span class="line">               &#125;</span><br><span class="line">               ...</span><br><span class="line">           &#125;</span><br><span class="line">           ...</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>移除了前面发送的Service创建超时ANR的延时消息。</p>
<h5 id="回调Service的onStartCommand-方法"><a href="#回调Service的onStartCommand-方法" class="headerlink" title="回调Service的onStartCommand()方法"></a>回调Service的onStartCommand()方法</h5><p>完成Service的创建之后，开始通知客户端进程回调Service的onStartCommand()方法。</p>
<h6 id="ActiveServices-sendServiceArgsLocked"><a href="#ActiveServices-sendServiceArgsLocked" class="headerlink" title="ActiveServices.sendServiceArgsLocked"></a>ActiveServices.sendServiceArgsLocked</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">sendServiceArgsLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> execInFg,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">boolean</span> oomAdjusted)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> N = r.pendingStarts.size();</span><br><span class="line">       <span class="keyword">if</span> (N == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       ArrayList&lt;ServiceStartArgs&gt; args = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">       <span class="keyword">while</span> (r.pendingStarts.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           ServiceRecord.StartItem si = r.pendingStarts.remove(<span class="number">0</span>);</span><br><span class="line">           <span class="keyword">if</span> (si.intent == <span class="keyword">null</span> &amp;&amp; N &gt; <span class="number">1</span>) &#123;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           si.deliveredTime = SystemClock.uptimeMillis();</span><br><span class="line">           r.deliveredStarts.add(si);</span><br><span class="line">           si.deliveryCount++;</span><br><span class="line">           <span class="keyword">if</span> (si.neededGrants != <span class="keyword">null</span>) &#123;</span><br><span class="line">               mAm.grantUriPermissionUncheckedFromIntentLocked(si.neededGrants, si.getUriPermissionsLocked());</span><br><span class="line">           &#125;</span><br><span class="line">           mAm.grantEphemeralAccessLocked(r.userId, si.intent, r.appInfo.uid, UserHandle.getAppId(si.callingId));</span><br><span class="line">           <span class="comment">//发送Service启动超时的延时消息</span></span><br><span class="line">           bumpServiceExecutingLocked(r, execInFg, <span class="string">"start"</span>);</span><br><span class="line">           <span class="keyword">if</span> (!oomAdjusted) &#123;</span><br><span class="line">               oomAdjusted = <span class="keyword">true</span>;</span><br><span class="line">               mAm.updateOomAdjLocked(r.app, <span class="keyword">true</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (r.fgRequired &amp;&amp; !r.fgWaiting) &#123;</span><br><span class="line">               <span class="keyword">if</span> (!r.isForeground) &#123;</span><br><span class="line">                   scheduleServiceForegroundTransitionTimeoutLocked(r);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   r.fgRequired = <span class="keyword">false</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">int</span> flags = <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">if</span> (si.deliveryCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">               flags |= Service.START_FLAG_RETRY;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (si.doneExecutingCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               flags |= Service.START_FLAG_REDELIVERY;</span><br><span class="line">           &#125;</span><br><span class="line">           args.add(<span class="keyword">new</span> ServiceStartArgs(si.taskRemoved, si.id, flags, si.intent));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       ParceledListSlice&lt;ServiceStartArgs&gt; slice = <span class="keyword">new</span> ParceledListSlice&lt;&gt;(args);</span><br><span class="line">       slice.setInlineCountLimit(<span class="number">4</span>);</span><br><span class="line">       Exception caughtException = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">       	<span class="comment">//向客户端进程发起IPC，最终回调Service的`onStartCommand()`</span></span><br><span class="line">           r.app.thread.scheduleServiceArgs(r, slice);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line">           caughtException = e;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">           caughtException = e;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           caughtException = e;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (caughtException != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.size(); i++) &#123;</span><br><span class="line">               serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (caughtException <span class="keyword">instanceof</span> TransactionTooLargeException) &#123;</span><br><span class="line">               <span class="keyword">throw</span> (TransactionTooLargeException)caughtException;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>发送Service启动超时的延时消息。类似流程3，当客户端进程成功回调<code>onStartCommand()</code>后，会通知AMS调用<code>serviceDoneExecuting()</code>移除ANS延时消息.<br>调用<code>sendServiceArgsLocked()</code>回调Service的<code>onStartCommand()</code>方法。</p>
<h5 id="客户端进程回调onStartCommand"><a href="#客户端进程回调onStartCommand" class="headerlink" title="客户端进程回调onStartCommand"></a>客户端进程回调onStartCommand</h5><p>经过Binder驱动，最终客户端进程的<code>ApplicationThread.scheduleServiceArgs()</code>被调用</p>
<h6 id="ApplicationThread-scheduleServiceArgs"><a href="#ApplicationThread-scheduleServiceArgs" class="headerlink" title="ApplicationThread.scheduleServiceArgs"></a>ApplicationThread.scheduleServiceArgs</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleServiceArgs</span><span class="params">(IBinder token, ParceledListSlice args)</span> </span>&#123;</span><br><span class="line">           List&lt;ServiceStartArgs&gt; list = args.getList();</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">               ServiceStartArgs ssa = list.get(i);</span><br><span class="line">               ServiceArgsData s = <span class="keyword">new</span> ServiceArgsData();</span><br><span class="line">               s.token = token;</span><br><span class="line">               s.taskRemoved = ssa.taskRemoved;</span><br><span class="line">               s.startId = ssa.startId;</span><br><span class="line">               s.flags = ssa.flags;</span><br><span class="line">               s.args = ssa.args;</span><br><span class="line">               sendMessage(H.SERVICE_ARGS, s);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p><code>token</code>：ServiceRecord。<br>构造ServiceStartArgs并发送给Hander，最终<code>ActivityThread.handleServiceArgs()</code>被调用。</p>
<h6 id="ActivityThread-handleServiceArgs"><a href="#ActivityThread-handleServiceArgs" class="headerlink" title="ActivityThread.handleServiceArgs"></a>ActivityThread.handleServiceArgs</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleServiceArgs</span><span class="params">(ServiceArgsData data)</span> </span>&#123;</span><br><span class="line">       Service s = mServices.get(data.token);</span><br><span class="line">       <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (data.args != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   data.args.setExtrasClassLoader(s.getClassLoader());</span><br><span class="line">                   data.args.prepareToEnterProcess();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">int</span> res;</span><br><span class="line">               <span class="keyword">if</span> (!data.taskRemoved) &#123;</span><br><span class="line">                   res = s.onStartCommand(data.args, data.flags, data.startId);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   s.onTaskRemoved(data.args);</span><br><span class="line">                   res = Service.START_TASK_REMOVED_COMPLETE;</span><br><span class="line">               &#125;</span><br><span class="line">               QueuedWork.waitToFinish();</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   ActivityManager.getService().serviceDoneExecuting(data.token, SERVICE_DONE_EXECUTING_START, data.startId, res);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">               &#125;</span><br><span class="line">               ensureJitEnabled();</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>通过<code>token</code>取出缓存的Service，回调其<code>onStartCommand()</code>；<br>跨进程调用<code>AMS.serviceDoneExecuting()</code>，根据<code>onStartCommand()</code>返回值处理Service被杀死后重启的逻辑，然后是移除Service启动超时ANR的消息(见4.2-4.4)。</p>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><ul>
<li>Service的创建依靠和AMS进程的交互，由AMS控制Service的合法性和权限，然后再通知客户端进程进行创建等操作。</li>
<li>Service的创建流程：<ul>
<li>进程A和AMS进程进行IPC，向AMS发送startService();</li>
<li>AMS进程收到请求后验证Intent信息，然后查询待启动Service所在进程是否启动，如果未启动则先通知Zygote进程创建待启动Service所在的进程B，并把Service添加到待启动Service列表中;</li>
<li>AMS进程通过Socket向Zygote进程通信，请求创建新进程，Zygote收到请求后fork子进程，当fork成功后子进程的ActivityThread的main方法被调用;</li>
<li>回到进程B中，进程B和AMS进程进行IPC，向AMS发送attachApplication();</li>
<li>回到AMS进程中，AMS查询待启动Service列表，调用ActiveServices.realStartServiceLocked()准备创建Service，前面如果待启动Service所在进程如果存在，则直接调用此方法;</li>
<li>AMS进程和进程B进程IPC，向进程B发送创建Service并回调其onCreate()、回调Service.onStartCommand()的命令;</li>
<li>进程B接受请求，反射创建Service并回调onCreate()、onStartCommand()，Service创建并启动完成。</li>
</ul>
</li>
<li>AMS在准备进行IPC调用进程B的onCreate()、onStartCommand()等之前均调用ActiveServices.bumpServiceExecutingLocked()发送一个延时的ANR的消息，当进程B完成onCreate()、onStartCommand()等之后，会再向AMS进程发起IPC调用AMS.serviceDoneExecuting()去移除那个延时的AND消息，如果时间到了进程B还未完成调用则会弹出ANR对话框。<strong>不要在onCreate()、onStartCommand()方法中做耗时任务，因为它们都运行在主线程</strong></li>
<li><strong>ANR超时时常</strong>：<code>SERVICE_TIMEOUT</code>：前台服务超时时间20秒。<code>SERVICE_BACKGROUND_TIMEOUT</code>：是前台服务的10倍，200秒。</li>
<li>关于AMS为Service创建新进程的形式和创建Activity当流程一致，均是和Zygote进程进行Socket通信，fork出子进程后再回到AMS进程继续Service的创建。</li>
</ul>
<!--
TODO Service的销毁

##### 客户端进程向AMS发起销毁Service请求

停止服务也在ContextImpl实现

###### ContextImpl.stopService

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">stopService</span><span class="params">(Intent service)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> stopServiceCommon(service, mUser);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h6 id="ContextImpl-stopServiceCommon"><a href="#ContextImpl-stopServiceCommon" class="headerlink" title="ContextImpl.stopServiceCommon"></a>ContextImpl.stopServiceCommon</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">stopServiceCommon</span><span class="params">(Intent service, UserHandle user)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           validateServiceIntent(service);</span><br><span class="line">           service.prepareToLeaveProcess(<span class="keyword">this</span>);</span><br><span class="line">           <span class="keyword">int</span> res = ActivityManager.getService().stopService(mMainThread.getApplicationThread(), service,</span><br><span class="line">               		service.resolveTypeIfNeeded(getContentResolver()), user.getIdentifier());</span><br><span class="line">           <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Not allowed to stop service "</span> + service);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> res != <span class="number">0</span>;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>经过Binder驱动，<code>AMS.stopService()</code>被调用。</p>
<h6 id="AMS-stopService"><a href="#AMS-stopService" class="headerlink" title="AMS.stopService"></a>AMS.stopService</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">stopService</span><span class="params">(IApplicationThread caller, Intent service, String resolvedType, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (service != <span class="keyword">null</span> &amp;&amp; service.hasFileDescriptors() == <span class="keyword">true</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> mServices.stopServiceLocked(caller, service, resolvedType, userId);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h6 id="ActiveServices-stopServiceLocked"><a href="#ActiveServices-stopServiceLocked" class="headerlink" title="ActiveServices.stopServiceLocked"></a>ActiveServices.stopServiceLocked</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">stopServiceLocked</span><span class="params">(IApplicationThread caller, Intent service,String resolvedType, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> ProcessRecord callerApp = mAm.getRecordForAppLocked(caller);</span><br><span class="line">       <span class="keyword">if</span> (caller != <span class="keyword">null</span> &amp;&amp; callerApp == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Unable to find app for caller "</span> + caller</span><br><span class="line">                   + <span class="string">" (pid="</span> + Binder.getCallingPid() + <span class="string">") when stopping service "</span> + service);</span><br><span class="line">       &#125;</span><br><span class="line">       ServiceLookupResult r = retrieveServiceLocked(service, resolvedType, <span class="keyword">null</span>,</span><br><span class="line">               Binder.getCallingPid(), Binder.getCallingUid(), userId, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">       <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (r.record != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   stopServiceLocked(r.record);</span><br><span class="line">               &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                   Binder.restoreCallingIdentity(origId);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>根据Intent信息找到ServiceRecord，调用stopServiceLocked()。</p>
<h6 id="ActiveServices-stopServiceLocked-1"><a href="#ActiveServices-stopServiceLocked-1" class="headerlink" title="ActiveServices.stopServiceLocked"></a>ActiveServices.stopServiceLocked</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopServiceLocked</span><span class="params">(ServiceRecord service)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (service.delayed) &#123;</span><br><span class="line">           service.delayedStop = <span class="keyword">true</span>;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">synchronized</span> (service.stats.getBatteryStats()) &#123;</span><br><span class="line">           service.stats.stopRunningLocked();</span><br><span class="line">       &#125;</span><br><span class="line">       service.startRequested = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">if</span> (service.tracker != <span class="keyword">null</span>) &#123;</span><br><span class="line">           service.tracker.setStarted(<span class="keyword">false</span>, mAm.mProcessStats.getMemFactorLocked(), SystemClock.uptimeMillis());</span><br><span class="line">       &#125;</span><br><span class="line">       service.callStart = <span class="keyword">false</span>;</span><br><span class="line">       bringDownServiceIfNeededLocked(service, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>设置ServiceRecord的标识</p>
<h6 id="ActiveServices-bringDownServiceIfNeededLocked"><a href="#ActiveServices-bringDownServiceIfNeededLocked" class="headerlink" title="ActiveServices.bringDownServiceIfNeededLocked"></a>ActiveServices.bringDownServiceIfNeededLocked</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bringDownServiceIfNeededLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> knowConn, <span class="keyword">boolean</span> hasConn)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (isServiceNeededLocked(r, knowConn, hasConn)) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (mPendingServices.contains(r)) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       bringDownServiceLocked(r);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h6 id="ActiveServices-bringDownServiceLocked"><a href="#ActiveServices-bringDownServiceLocked" class="headerlink" title="ActiveServices.bringDownServiceLocked"></a>ActiveServices.bringDownServiceLocked</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bringDownServiceLocked</span><span class="params">(ServiceRecord r)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//Slog.i(TAG, "Bring down service:");</span></span><br><span class="line">       <span class="comment">//r.dump("  ");</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">// Report to all of the connections that the service is no longer</span></span><br><span class="line">       <span class="comment">// available.</span></span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> conni=r.connections.size()-<span class="number">1</span>; conni&gt;=<span class="number">0</span>; conni--) &#123;</span><br><span class="line">           ArrayList&lt;ConnectionRecord&gt; c = r.connections.valueAt(conni);</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;c.size(); i++) &#123;</span><br><span class="line">               ConnectionRecord cr = c.get(i);</span><br><span class="line">               <span class="comment">// There is still a connection to the service that is</span></span><br><span class="line">               <span class="comment">// being brought down.  Mark it as dead.</span></span><br><span class="line">               cr.serviceDead = <span class="keyword">true</span>;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   cr.conn.connected(r.name, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                   Slog.w(TAG, <span class="string">"Failure disconnecting service "</span> + r.name +</span><br><span class="line">                         <span class="string">" to connection "</span> + c.get(i).conn.asBinder() +</span><br><span class="line">                         <span class="string">" (in "</span> + c.get(i).binding.client.processName + <span class="string">")"</span>, e);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Tell the service that it has been unbound.</span></span><br><span class="line">       <span class="keyword">if</span> (r.app != <span class="keyword">null</span> &amp;&amp; r.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i=r.bindings.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">               IntentBindRecord ibr = r.bindings.valueAt(i);</span><br><span class="line">               <span class="keyword">if</span> (ibr.hasBound) &#123;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       bumpServiceExecutingLocked(r, <span class="keyword">false</span>, <span class="string">"bring down unbind"</span>);</span><br><span class="line">                       mAm.updateOomAdjLocked(r.app, <span class="keyword">true</span>);</span><br><span class="line">                       ibr.hasBound = <span class="keyword">false</span>;</span><br><span class="line">                       ibr.requested = <span class="keyword">false</span>;</span><br><span class="line">                       r.app.thread.scheduleUnbindService(r,</span><br><span class="line">                               ibr.intent.getIntent());</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                       Slog.w(TAG, <span class="string">"Exception when unbinding service "</span></span><br><span class="line">                               + r.shortName, e);</span><br><span class="line">                       serviceProcessGoneLocked(r);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Check to see if the service had been started as foreground, but being</span></span><br><span class="line">       <span class="comment">// brought down before actually showing a notification.  That is not allowed.</span></span><br><span class="line">       <span class="keyword">if</span> (r.fgRequired) &#123;</span><br><span class="line">           r.fgRequired = <span class="keyword">false</span>;</span><br><span class="line">           r.fgWaiting = <span class="keyword">false</span>;</span><br><span class="line">           mAm.mAppOpsService.finishOperation(AppOpsManager.getToken(mAm.mAppOpsService),</span><br><span class="line">                   AppOpsManager.OP_START_FOREGROUND, r.appInfo.uid, r.packageName);</span><br><span class="line">           mAm.mHandler.removeMessages(</span><br><span class="line">                   ActivityManagerService.SERVICE_FOREGROUND_TIMEOUT_MSG, r);</span><br><span class="line">           <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">               Message msg = mAm.mHandler.obtainMessage(</span><br><span class="line">                       ActivityManagerService.SERVICE_FOREGROUND_CRASH_MSG);</span><br><span class="line">               msg.obj = r.app;</span><br><span class="line">               msg.getData().putCharSequence(</span><br><span class="line">                   ActivityManagerService.SERVICE_RECORD_KEY, r.toString());</span><br><span class="line">               mAm.mHandler.sendMessage(msg);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (DEBUG_SERVICE) &#123;</span><br><span class="line">           RuntimeException here = <span class="keyword">new</span> RuntimeException();</span><br><span class="line">           here.fillInStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">       r.destroyTime = SystemClock.uptimeMillis();</span><br><span class="line">       <span class="keyword">final</span> ServiceMap smap = getServiceMapLocked(r.userId);</span><br><span class="line">       ServiceRecord found = smap.mServicesByName.remove(r.name);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Note when this method is called by bringUpServiceLocked(), the service is not found</span></span><br><span class="line">       <span class="comment">// in mServicesByName and found will be null.</span></span><br><span class="line">       <span class="keyword">if</span> (found != <span class="keyword">null</span> &amp;&amp; found != r) &#123;</span><br><span class="line">           <span class="comment">// This is not actually the service we think is running...  this should not happen,</span></span><br><span class="line">           <span class="comment">// but if it does, fail hard.</span></span><br><span class="line">           smap.mServicesByName.put(r.name, found);</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Bringing down "</span> + r + <span class="string">" but actually running "</span></span><br><span class="line">                   + found);</span><br><span class="line">       &#125;</span><br><span class="line">       smap.mServicesByIntent.remove(r.intent);</span><br><span class="line">       r.totalRestartCount = <span class="number">0</span>;</span><br><span class="line">       unscheduleServiceRestartLocked(r, <span class="number">0</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Also make sure it is not on the pending list.</span></span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i=mPendingServices.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">           <span class="keyword">if</span> (mPendingServices.get(i) == r) &#123;</span><br><span class="line">               mPendingServices.remove(i);</span><br><span class="line">               <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Removed pending: "</span> + r);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       cancelForegroundNotificationLocked(r);</span><br><span class="line">       <span class="keyword">if</span> (r.isForeground) &#123;</span><br><span class="line">           decActiveForegroundAppLocked(smap, r);</span><br><span class="line">           mAm.mAppOpsService.finishOperation(</span><br><span class="line">                   AppOpsManager.getToken(mAm.mAppOpsService),</span><br><span class="line">                   AppOpsManager.OP_START_FOREGROUND, r.appInfo.uid, r.packageName);</span><br><span class="line">           StatsLog.write(StatsLog.FOREGROUND_SERVICE_STATE_CHANGED, r.appInfo.uid, r.shortName,</span><br><span class="line">                   StatsLog.FOREGROUND_SERVICE_STATE_CHANGED__STATE__EXIT);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       r.isForeground = <span class="keyword">false</span>;</span><br><span class="line">       r.foregroundId = <span class="number">0</span>;</span><br><span class="line">       r.foregroundNoti = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Clear start entries.</span></span><br><span class="line">       r.clearDeliveredStartsLocked();</span><br><span class="line">       r.pendingStarts.clear();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</span><br><span class="line">               r.stats.stopLaunchedLocked();</span><br><span class="line">           &#125;</span><br><span class="line">           r.app.services.remove(r);</span><br><span class="line">           <span class="keyword">if</span> (r.whitelistManager) &#123;</span><br><span class="line">               updateWhitelistManagerLocked(r.app);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (r.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">               updateServiceForegroundLocked(r.app, <span class="keyword">false</span>);</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   bumpServiceExecutingLocked(r, <span class="keyword">false</span>, <span class="string">"destroy"</span>);</span><br><span class="line">                   mDestroyingServices.add(r);</span><br><span class="line">                   r.destroying = <span class="keyword">true</span>;</span><br><span class="line">                   mAm.updateOomAdjLocked(r.app, <span class="keyword">true</span>);</span><br><span class="line">                   r.app.thread.scheduleStopService(r);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                   Slog.w(TAG, <span class="string">"Exception when destroying service "</span></span><br><span class="line">                           + r.shortName, e);</span><br><span class="line">                   serviceProcessGoneLocked(r);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           </span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (r.bindings.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           r.bindings.clear();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (r.restarter <span class="keyword">instanceof</span> ServiceRestarter) &#123;</span><br><span class="line">          ((ServiceRestarter)r.restarter).setService(<span class="keyword">null</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">int</span> memFactor = mAm.mProcessStats.getMemFactorLocked();</span><br><span class="line">       <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">       <span class="keyword">if</span> (r.tracker != <span class="keyword">null</span>) &#123;</span><br><span class="line">           r.tracker.setStarted(<span class="keyword">false</span>, memFactor, now);</span><br><span class="line">           r.tracker.setBound(<span class="keyword">false</span>, memFactor, now);</span><br><span class="line">           <span class="keyword">if</span> (r.executeNesting == <span class="number">0</span>) &#123;</span><br><span class="line">               r.tracker.clearCurrentOwner(r, <span class="keyword">false</span>);</span><br><span class="line">               r.tracker = <span class="keyword">null</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       smap.ensureNotStartingBackgroundLocked(r);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h6 id="AT-scheduleStopService"><a href="#AT-scheduleStopService" class="headerlink" title="AT.scheduleStopService"></a>AT.scheduleStopService</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleStopService</span><span class="params">(IBinder token)</span> </span>&#123;</span><br><span class="line">           sendMessage(H.STOP_SERVICE, token);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<h6 id="AT-handleStopService"><a href="#AT-handleStopService" class="headerlink" title="AT.handleStopService"></a>AT.handleStopService</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleStopService</span><span class="params">(IBinder token)</span> </span>&#123;</span><br><span class="line">       Service s = mServices.remove(token);</span><br><span class="line">       <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               s.onDestroy();</span><br><span class="line">               s.detachAndCleanUp();</span><br><span class="line">               Context context = s.getBaseContext();</span><br><span class="line">               <span class="keyword">if</span> (context <span class="keyword">instanceof</span> ContextImpl) &#123;</span><br><span class="line">                   <span class="keyword">final</span> String who = s.getClassName();</span><br><span class="line">                   ((ContextImpl) context).scheduleFinalCleanup(who, <span class="string">"Service"</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               QueuedWork.waitToFinish();</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   ActivityManager.getService().serviceDoneExecuting(token, SERVICE_DONE_EXECUTING_STOP, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>回调Service的onDestroy方法，并移除了Service销毁的ANR延时消息</p>
<p>–&gt;</p>
-->
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/framework/" rel="tag"># framework</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/24/Android-28版本有关AMS回调Activity生命周期的流程/" rel="next" title="Android-28版本有关AMS回调Activity生命周期的流程">
                <i class="fa fa-chevron-left"></i> Android-28版本有关AMS回调Activity生命周期的流程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Chenjialong</p>
              <p class="site-description motion-element" itemprop="description">Chenjialong Blog</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-5"><a class="nav-link" href="#客户端进程向AMS发起启动Service请求"><span class="nav-number">1.</span> <span class="nav-text">客户端进程向AMS发起启动Service请求</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ContextWrapper-startService"><span class="nav-number">1.1.</span> <span class="nav-text">ContextWrapper.startService</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ContextImpl-startService"><span class="nav-number">1.2.</span> <span class="nav-text">ContextImpl.startService</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ContextImpl-startServiceCommon"><span class="nav-number">1.3.</span> <span class="nav-text">ContextImpl.startServiceCommon</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AMS处理Intent信息及一些情况"><span class="nav-number">2.</span> <span class="nav-text">AMS处理Intent信息及一些情况</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#AMS-startService"><span class="nav-number">2.1.</span> <span class="nav-text">AMS.startService</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ActiveServices-startServiceLocked"><span class="nav-number">2.2.</span> <span class="nav-text">ActiveServices.startServiceLocked</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ActiveServices-startServiceInnerLocked"><span class="nav-number">2.3.</span> <span class="nav-text">ActiveServices.startServiceInnerLocked</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ActiveServices-bringUpServiceLocked"><span class="nav-number">2.4.</span> <span class="nav-text">ActiveServices.bringUpServiceLocked</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ActiveServices-realStartServiceLocked"><span class="nav-number">2.5.</span> <span class="nav-text">ActiveServices.realStartServiceLocked</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#发送Service创建超时的延时消息"><span class="nav-number">3.</span> <span class="nav-text">发送Service创建超时的延时消息</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ActiveServices-bumpServiceExecutingLocked"><span class="nav-number">3.1.</span> <span class="nav-text">ActiveServices.bumpServiceExecutingLocked</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ActiveServices-scheduleServiceTimeoutLocked"><span class="nav-number">3.2.</span> <span class="nav-text">ActiveServices.scheduleServiceTimeoutLocked</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#向客户端发起IPC进行Service的创建"><span class="nav-number">4.</span> <span class="nav-text">向客户端发起IPC进行Service的创建</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ApplicationThread-scheduleCreateService"><span class="nav-number">4.1.</span> <span class="nav-text">ApplicationThread.scheduleCreateService</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ActivityThread-handleCreateService"><span class="nav-number">4.2.</span> <span class="nav-text">ActivityThread.handleCreateService</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#AMS-serviceDoneExecuting"><span class="nav-number">4.3.</span> <span class="nav-text">AMS.serviceDoneExecuting</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ActiveServices-serviceDoneExecutingLocked"><span class="nav-number">4.4.</span> <span class="nav-text">ActiveServices.serviceDoneExecutingLocked</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#回调Service的onStartCommand-方法"><span class="nav-number">5.</span> <span class="nav-text">回调Service的onStartCommand()方法</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ActiveServices-sendServiceArgsLocked"><span class="nav-number">5.1.</span> <span class="nav-text">ActiveServices.sendServiceArgsLocked</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#客户端进程回调onStartCommand"><span class="nav-number">6.</span> <span class="nav-text">客户端进程回调onStartCommand</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ApplicationThread-scheduleServiceArgs"><span class="nav-number">6.1.</span> <span class="nav-text">ApplicationThread.scheduleServiceArgs</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ActivityThread-handleServiceArgs"><span class="nav-number">6.2.</span> <span class="nav-text">ActivityThread.handleServiceArgs</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#总结"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chenjialong</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>








        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
